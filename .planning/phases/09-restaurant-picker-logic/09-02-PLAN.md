---
phase: 09-restaurant-picker-logic
plan: 02
type: execute
---

<objective>
Build the restaurant picker UI with card stack, skip/like actions, and ranking logic.

Purpose: Enable the core "decide where to eat now" user job - users swipe through ranked restaurants and pick one within 60 seconds.
Output: RestaurantPicker component integrated into Now screen with real API data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/09-restaurant-picker-logic/09-01-SUMMARY.md

# Components available
@mobile/components/SwipeableCard.tsx
@mobile/components/RestaurantCard.tsx
@mobile/lib/use-places.ts
@mobile/lib/use-location.ts
@mobile/app/(tabs)/now.tsx

**Tech stack available:**
- SwipeableCard with onSkip/onLike callbacks
- RestaurantCard displays place info
- usePlaces hook fetches from API
- useLocation provides user coordinates

**UX Requirements from PROJECT.md:**
- User can select a restaurant within 60 seconds
- Interfaces should feel calm and low-density
- App must be usable with one hand
- Playful and tactile design

**Ranking approach (from PROJECT.md constraints):**
- Rule-based, not ML-driven
- Simple and explicit
- Preference-based (influences ranking without strict exclusion)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RestaurantPicker component</name>
  <files>mobile/components/RestaurantPicker.tsx</files>
  <action>
    Create a card stack container that manages skip/like state:

    ```typescript
    import { useState, useCallback } from 'react';
    import { View, Text, StyleSheet, ActivityIndicator } from 'react-native';
    import { SwipeableCard } from './SwipeableCard';
    import { Place } from './PlaceMarker';

    interface RestaurantPickerProps {
      places: Place[];
      loading: boolean;
      error: string | null;
      onLike: (place: Place) => void;
    }

    export function RestaurantPicker({ places, loading, error, onLike }: RestaurantPickerProps) {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [skippedIds, setSkippedIds] = useState<Set<string>>(new Set());

      // Filter out skipped places
      const availablePlaces = places.filter(p => !skippedIds.has(p.google_place_id));
      const currentPlace = availablePlaces[0];

      const handleSkip = useCallback((place: Place) => {
        setSkippedIds(prev => new Set(prev).add(place.google_place_id));
      }, []);

      const handleLike = useCallback((place: Place) => {
        // Remove from stack and notify parent
        setSkippedIds(prev => new Set(prev).add(place.google_place_id));
        onLike(place);
      }, [onLike]);

      if (loading) {
        return (
          <View style={styles.centered}>
            <ActivityIndicator size="large" color="#F97316" />
            <Text style={styles.loadingText}>Finding restaurants...</Text>
          </View>
        );
      }

      if (error) {
        return (
          <View style={styles.centered}>
            <Text style={styles.errorText}>{error}</Text>
          </View>
        );
      }

      if (!currentPlace) {
        return (
          <View style={styles.centered}>
            <Text style={styles.emptyText}>No more restaurants nearby</Text>
            <Text style={styles.hintText}>Try expanding your search area</Text>
          </View>
        );
      }

      return (
        <View style={styles.container}>
          <SwipeableCard
            key={currentPlace.google_place_id}
            place={currentPlace}
            onSkip={handleSkip}
            onLike={handleLike}
          />
          <Text style={styles.countText}>
            {availablePlaces.length} restaurants nearby
          </Text>
        </View>
      );
    }
    ```

    Styling:
    - Center card in container
    - Show count of remaining restaurants below
    - Loading/error/empty states
    - Use UI_SPEC colors (#F97316 accent, #1F2937 text)
  </action>
  <verify>
    1. File exists: mobile/components/RestaurantPicker.tsx
    2. cd mobile && npm run tsc (no new TypeScript errors)
    3. Component handles loading, error, empty, and normal states
  </verify>
  <done>
    - RestaurantPicker component created
    - Manages skip/like state with skippedIds Set
    - Shows loading, error, empty states
    - Displays remaining count
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ranking logic</name>
  <files>mobile/lib/rank-places.ts</files>
  <action>
    Create a simple ranking function that sorts places by desirability:

    ```typescript
    import { Place } from '../components/PlaceMarker';

    /**
     * Rank places by desirability for the "decide now" use case.
     *
     * Scoring (higher = better):
     * - Rating: 0-5 points (direct rating value)
     * - Has rating: +1 point (prefer rated over unrated)
     *
     * Future additions (when data available):
     * - Open now: +2 points
     * - Distance: inverse scoring
     * - Price match: +1 if matches preference
     */
    export function rankPlaces(places: Place[]): Place[] {
      return [...places].sort((a, b) => {
        const scoreA = getScore(a);
        const scoreB = getScore(b);
        return scoreB - scoreA; // Higher score first
      });
    }

    function getScore(place: Place): number {
      let score = 0;

      // Rating score (0-5)
      if (place.rating) {
        score += place.rating;
        score += 1; // Bonus for having a rating
      }

      return score;
    }
    ```

    Keep it simple for MVP:
    - Just use rating for now
    - Function is pure and testable
    - Easy to extend with more factors later
  </action>
  <verify>
    1. File exists: mobile/lib/rank-places.ts
    2. cd mobile && npm run tsc (no new TypeScript errors)
    3. Exports rankPlaces function
  </verify>
  <done>
    - rankPlaces function created
    - Sorts by rating (higher first)
    - Pure function, easy to test
    - Extensible for future factors
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate picker into Now screen</name>
  <files>mobile/app/(tabs)/now.tsx</files>
  <action>
    Update Now screen to use RestaurantPicker with real API data:

    1. Import usePlaces hook and RestaurantPicker
    2. Import rankPlaces function
    3. Replace mock data with usePlaces hook
    4. Add RestaurantPicker overlaid on map (or toggle between views)
    5. Handle onLike callback (for now, just log - Phase 10 will add saving)

    Key changes:
    ```typescript
    import { usePlaces } from '../../lib/use-places';
    import { rankPlaces } from '../../lib/rank-places';
    import { RestaurantPicker } from '../../components/RestaurantPicker';

    export default function NowScreen() {
      const { location, loading: locationLoading, error: locationError, requestPermission } = useLocation();
      const { places, loading: placesLoading, error: placesError } = usePlaces(
        location ? { latitude: location.latitude, longitude: location.longitude } : null
      );

      // Rank places for picker
      const rankedPlaces = rankPlaces(places);

      const handleLike = (place: Place) => {
        console.log('Liked:', place.name);
        // TODO: Phase 10 will add saving functionality
      };

      // Show picker overlay on top of map
      return (
        <View style={styles.container}>
          <MapView ... />
          <View style={styles.pickerContainer}>
            <RestaurantPicker
              places={rankedPlaces}
              loading={placesLoading}
              error={placesError}
              onLike={handleLike}
            />
          </View>
        </View>
      );
    }
    ```

    Layout approach:
    - Map fills screen as background
    - Picker overlays in center (absolute positioning)
    - Card floats above map for context

    Remove mock data - no longer needed.
  </action>
  <verify>
    1. Now screen imports and uses RestaurantPicker
    2. Mock data removed
    3. usePlaces hook called with location
    4. rankPlaces applied to places
    5. cd mobile && npm run tsc (no new TypeScript errors)
  </verify>
  <done>
    - Now screen uses real API data via usePlaces
    - RestaurantPicker displays ranked restaurants
    - Skip/like gestures work
    - Map visible behind cards
    - Mock data removed
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RestaurantPicker component created and working
- [ ] rankPlaces function created
- [ ] Now screen integrated with picker and API
- [ ] Mock data removed from now.tsx
- [ ] cd mobile && npm run tsc (no new TypeScript errors)
</verification>

<success_criteria>

- All tasks completed
- Restaurant cards display real data from API
- Skip removes card, like logs and removes
- Cards ranked by rating
- Core "decide where to eat" flow works
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-restaurant-picker-logic/09-02-SUMMARY.md`

Phase 9 complete - ready for Phase 10: Saved Places
</output>
