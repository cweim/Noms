---
phase: 09-restaurant-picker-logic
plan: 01
type: execute
---

<objective>
Create API client and data fetching hook to connect mobile app to backend Places API.

Purpose: Enable the mobile app to fetch real restaurant data from the backend instead of mock data. This is the data layer foundation for the restaurant picker.
Output: API client module and usePlaces hook that fetches restaurants based on user location.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/08-restaurant-cards/08-01-SUMMARY.md
@.planning/phases/05-google-places-integration/05-02-SUMMARY.md

# Current mobile setup
@mobile/lib/supabase.ts
@mobile/lib/use-location.ts
@mobile/components/PlaceMarker.tsx

**Tech stack available:**
- Expo ~54.0.31 with React 19.1.0
- Supabase client configured in mobile/lib/supabase.ts
- useLocation hook returns { latitude, longitude } region

**Backend API available:**
- GET /api/places/search?q={query}&lat={lat}&lng={lng}&radius={radius}
- Requires JWT auth (from Supabase session)
- Returns PlaceSearchResponse with places array

**Established patterns:**
- Supabase client exports from mobile/lib/supabase.ts
- Custom hooks in mobile/lib/ directory
- Place interface from PlaceMarker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client module</name>
  <files>mobile/lib/api.ts</files>
  <action>
    Create an API client module that:

    1. Reads EXPO_PUBLIC_API_URL from environment (default to http://localhost:8000)
    2. Gets JWT token from Supabase session for auth header
    3. Exports async functions for API calls:
       - `searchPlaces(params: { lat, lng, radius?, query? })` - calls GET /api/places/search

    4. Handle errors gracefully - throw with meaningful messages

    Structure:
    ```typescript
    import { supabase } from './supabase';

    const API_URL = process.env.EXPO_PUBLIC_API_URL || 'http://localhost:8000';

    async function getAuthHeaders() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        throw new Error('Not authenticated');
      }
      return {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json',
      };
    }

    export async function searchPlaces({ lat, lng, radius = 1000, query = 'restaurant' }) {
      const headers = await getAuthHeaders();
      const params = new URLSearchParams({
        q: query,
        lat: lat.toString(),
        lng: lng.toString(),
        radius: radius.toString(),
      });

      const response = await fetch(`${API_URL}/api/places/search?${params}`, { headers });
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      return response.json();
    }
    ```

    Keep it simple - just the search function for now. Details/photo endpoints can be added later.
  </action>
  <verify>
    1. File exists: mobile/lib/api.ts
    2. cd mobile && npm run tsc (no new TypeScript errors)
    3. Exports searchPlaces function
  </verify>
  <done>
    - API client module created
    - searchPlaces function uses Supabase JWT for auth
    - Configurable API_URL via environment variable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePlaces hook</name>
  <files>mobile/lib/use-places.ts</files>
  <action>
    Create a React hook that fetches places based on location:

    ```typescript
    import { useState, useEffect } from 'react';
    import { searchPlaces } from './api';
    import { Place } from '../components/PlaceMarker';

    interface UsePlacesResult {
      places: Place[];
      loading: boolean;
      error: string | null;
      refetch: () => Promise<void>;
    }

    export function usePlaces(
      location: { latitude: number; longitude: number } | null,
      options?: { radius?: number; query?: string }
    ): UsePlacesResult {
      const [places, setPlaces] = useState<Place[]>([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState<string | null>(null);

      const fetchPlaces = async () => {
        if (!location) return;

        setLoading(true);
        setError(null);

        try {
          const response = await searchPlaces({
            lat: location.latitude,
            lng: location.longitude,
            radius: options?.radius || 1000,
            query: options?.query || 'restaurant',
          });

          // Map API response to Place interface
          setPlaces(response.places.map((p: any) => ({
            google_place_id: p.google_place_id,
            name: p.name,
            address: p.address,
            location: p.location,
            rating: p.rating,
          })));
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Failed to fetch places');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        fetchPlaces();
      }, [location?.latitude, location?.longitude]);

      return { places, loading, error, refetch: fetchPlaces };
    }
    ```

    Key behaviors:
    - Fetches when location changes
    - Returns loading/error states for UI
    - Maps API response to Place interface (compatible with PlaceMarker/RestaurantCard)
    - Provides refetch function for pull-to-refresh
  </action>
  <verify>
    1. File exists: mobile/lib/use-places.ts
    2. cd mobile && npm run tsc (no new TypeScript errors)
    3. Hook exports usePlaces function
  </verify>
  <done>
    - usePlaces hook created
    - Fetches places when location available
    - Returns places, loading, error, refetch
    - Compatible with existing Place interface
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] mobile/lib/api.ts exists with searchPlaces function
- [ ] mobile/lib/use-places.ts exists with usePlaces hook
- [ ] cd mobile && npm run tsc (no new TypeScript errors from these files)
- [ ] Both files use proper TypeScript types
</verification>

<success_criteria>

- All tasks completed
- API client can make authenticated requests to backend
- usePlaces hook fetches and returns places array
- Types compatible with existing Place interface
</success_criteria>

<output>
After completion, create `.planning/phases/09-restaurant-picker-logic/09-01-SUMMARY.md`

Ready for 09-02-PLAN.md: Restaurant Picker UI
</output>
