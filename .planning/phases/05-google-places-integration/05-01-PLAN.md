---
phase: 05-google-places-integration
plan: 01
type: execute
---

<objective>
Create Google Places service module with API client wrapper and caching logic.

Purpose: Establish the foundation for querying Google Places API and caching results to reduce API costs and improve response times.
Output: Places service module that wraps googlemaps library and implements database caching.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-google-places-integration/DISCOVERY.md

# Prior phase context
@.planning/phases/03-backend-api-foundation/03-01-SUMMARY.md
@.planning/phases/03-backend-api-foundation/03-02-SUMMARY.md

# Existing backend structure
@backend/app/main.py
@backend/app/db.py
@backend/app/errors.py
@backend/requirements.txt
@backend/.env.example

# Database schema
@backend/supabase/migrations/20260113000001_create_core_schema.sql

**Tech stack available:**
- FastAPI 0.109.0 with async support
- Supabase Python client (supabase==2.3.0)
- Pydantic for data validation
- Custom exception handlers (DatabaseError, ValidationError, etc.)

**Established patterns:**
- Singleton Supabase client with SERVICE_KEY (backend/app/db.py)
- Router organization by feature (/api/users, /api/places)
- Centralized error handling with custom exceptions

**Constraining decisions:**
- Phase 2: Places table with google_place_id, name, address, photo_reference, types, last_fetched_at
- Phase 3: SERVICE_KEY used for backend admin operations (bypasses RLS for caching)
- Discovery: Use googlemaps library (Legacy API) for simplicity

**From DISCOVERY.md:**
- googlemaps==4.10.0 for Places API access
- Key methods: places(), places_nearby(), place(), places_photo()
- Cache to places table, check last_fetched_at for staleness (7 days)
- Handle ZERO_RESULTS, OVER_QUERY_LIMIT, REQUEST_DENIED errors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add googlemaps dependency and create places service</name>
  <files>backend/requirements.txt, backend/app/services/__init__.py, backend/app/services/places.py, backend/.env.example</files>
  <action>
    1. Add googlemaps==4.10.0 to requirements.txt
    2. Create backend/app/services/ directory with __init__.py
    3. Create backend/app/services/places.py with:
       - GooglePlacesService class
       - __init__ that reads GOOGLE_PLACES_API_KEY from env and creates googlemaps.Client
       - search_places(query, lat, lng, radius=1000) method that calls gmaps.places()
       - get_place_details(google_place_id) method that calls gmaps.place()
       - get_place_photo(photo_reference, max_width=400) method that calls gmaps.places_photo()
    4. Add singleton pattern: get_places_service() function similar to get_supabase()
    5. Handle API errors:
       - googlemaps.exceptions.ApiError → map to appropriate custom exception
       - ZERO_RESULTS → return empty list (not an error)
       - OVER_QUERY_LIMIT → raise DatabaseError with "Rate limited" message
       - REQUEST_DENIED → raise ValidationError with "Invalid API key" message
    6. Add GOOGLE_PLACES_API_KEY to .env.example with comment

    Do NOT implement caching yet - that's Task 2.
    Do NOT create endpoints yet - that's Plan 05-02.
  </action>
  <verify>
    1. googlemaps appears in requirements.txt
    2. backend/app/services/places.py imports successfully: python -c "from app.services.places import get_places_service; print('OK')"
    3. .env.example contains GOOGLE_PLACES_API_KEY entry
  </verify>
  <done>
    - googlemaps==4.10.0 added to dependencies
    - GooglePlacesService class with search, details, photo methods
    - Singleton pattern via get_places_service()
    - Error mapping for API errors
    - Environment variable template updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement caching logic for places</name>
  <files>backend/app/services/places.py</files>
  <action>
    Add caching methods to GooglePlacesService class:

    1. Add cache_place(place_data: dict) method:
       - Upserts place to database using google_place_id as unique key
       - Maps API response fields to database columns:
         - place_id → google_place_id
         - name → name
         - vicinity or formatted_address → address
         - photos[0].photo_reference → photo_reference (if exists)
         - types → types (as array)
       - Sets last_fetched_at to NOW()
       - Uses Supabase upsert with on_conflict="google_place_id"

    2. Add get_cached_place(google_place_id: str) method:
       - Queries places table by google_place_id
       - Returns place dict if found and not stale
       - Returns None if not found or stale (last_fetched_at > 7 days)

    3. Add is_cache_stale(last_fetched_at: datetime) helper:
       - Returns True if last_fetched_at is None or > 7 days ago
       - Use timedelta(days=7) for staleness check

    4. Modify search_places() to cache results:
       - After successful API call, cache each place in results
       - Return places with internal UUID (from cache) added

    5. Modify get_place_details() to check cache first:
       - Call get_cached_place() first
       - If cached and fresh, return cached data
       - If not cached or stale, call API and cache result

    Import get_supabase from app.db for database access.
    Use datetime.now(timezone.utc) for timestamp comparisons.
  </action>
  <verify>
    1. places.py has cache_place and get_cached_place methods
    2. Module imports without errors: python -c "from app.services.places import GooglePlacesService; print('OK')"
    3. Caching methods reference supabase client
  </verify>
  <done>
    - cache_place() upserts place data to database
    - get_cached_place() retrieves cached place by google_place_id
    - is_cache_stale() checks 7-day freshness
    - search_places() caches results after API call
    - get_place_details() checks cache before API call
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] googlemaps installed: pip list | grep googlemaps
- [ ] backend/app/services/places.py imports without errors
- [ ] GooglePlacesService has search_places, get_place_details, get_place_photo methods
- [ ] Caching methods cache_place and get_cached_place implemented
- [ ] No import errors or startup failures
</verification>

<success_criteria>

- All tasks completed
- GooglePlacesService wraps googlemaps library
- Caching logic implemented with 7-day staleness
- Error handling maps API errors to custom exceptions
- No errors introduced, module imports cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-google-places-integration/05-01-SUMMARY.md`
</output>
