---
phase: 16-place-details-screen
plan: 01
type: execute
---

<objective>
Create Place Details Screen with full restaurant information

Purpose: Allow users to view comprehensive details about a restaurant including photos, hours, contact info, and ratings.
Output: PlaceDetailsScreen component and API client function, accessible via navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-bug-fix-backend-prep/13-02-SUMMARY.md

**Key files:**
@mobile/lib/api.ts
@mobile/app/_layout.tsx
@backend/app/schemas/places.py

**Backend ready (from Phase 13-02):**
- `GET /api/places/{place_id}/details` returns PlaceDetails schema
- Response includes: place_id, name, address, phone, website, rating, price_level, opening_hours, photos[], types[], lat, lng
- Photos limited to 5, opening_hours has open_now and weekday_text

**Tech stack available:**
- React Native with Expo Router
- expo-linking for phone/website actions
- react-native-maps for location display (optional)
- Ionicons for icons

**Established patterns:**
- API client functions in mobile/lib/api.ts
- Components in mobile/components/
- Screens use useSafeAreaInsets for proper spacing
- Photo URLs via getPhotoUrl(googlePlaceId, token, maxWidth)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getPlaceDetails API function</name>
  <files>mobile/lib/api.ts</files>
  <action>
  Add PlaceDetails type and getPlaceDetails function to API client:

  1. Add PlaceDetails interface matching backend schema:
     ```typescript
     export interface PlaceDetails {
       place_id: string;
       name: string;
       address: string | null;
       phone: string | null;
       website: string | null;
       rating: number | null;
       price_level: number | null;
       opening_hours: {
         open_now: boolean | null;
         weekday_text: string[] | null;
       } | null;
       photos: Array<{
         photo_reference: string;
         height: number | null;
         width: number | null;
       }>;
       types: string[];
       lat: number | null;
       lng: number | null;
     }
     ```

  2. Add getPlaceDetails function:
     ```typescript
     export async function getPlaceDetails(googlePlaceId: string): Promise<PlaceDetails> {
       const headers = await getAuthHeaders();
       const response = await fetch(`${API_BASE_URL}/api/places/${googlePlaceId}/details`, {
         method: 'GET',
         headers,
       });

       if (!response.ok) {
         throw new Error('Failed to fetch place details');
       }

       return response.json();
     }
     ```

  3. Add getPhotoUrlFromReference helper for gallery photos (uses photo_reference directly):
     ```typescript
     export function getPhotoUrlFromReference(photoReference: string, token: string, maxWidth: number = 800): string {
       return `${API_BASE_URL}/api/places/photo?photo_reference=${encodeURIComponent(photoReference)}&max_width=${maxWidth}&token=${encodeURIComponent(token)}`;
     }
     ```

  Note: The existing getPhotoUrl uses google_place_id to look up photo_reference. For gallery photos, we already have photo_references from the details endpoint.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>PlaceDetails type and getPlaceDetails function exported from api.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create PlaceDetailsScreen component</name>
  <files>mobile/app/place/[id].tsx</files>
  <action>
  Create a new screen at mobile/app/place/[id].tsx for place details:

  **Route structure:** Dynamic route using Expo Router's file-based routing.
  - URL: /place/{google_place_id}
  - Access via: router.push(`/place/${place.google_place_id}`)

  **Layout (scrollable):**
  ```
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ [Back button]              [Share btn] ‚îÇ  <- Header with safe area
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ  <- Photo gallery (horizontal scroll)
  ‚îÇ ‚îÇ img1 ‚îÇ‚îÇ img2 ‚îÇ‚îÇ img3 ‚îÇ  ...          ‚îÇ     Height: 200px
  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ Restaurant Name                    ‚òÖ4.5‚îÇ  <- Name + rating
  ‚îÇ $$  ‚Ä¢  Italian  ‚Ä¢  Open now            ‚îÇ  <- Price + type + status
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ üìç 123 Main Street, City               ‚îÇ  <- Address (tappable ‚Üí maps)
  ‚îÇ üìû (123) 456-7890                      ‚îÇ  <- Phone (tappable ‚Üí call)
  ‚îÇ üåê website.com                         ‚îÇ  <- Website (tappable ‚Üí browser)
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ Hours                                  ‚îÇ  <- Collapsible hours section
  ‚îÇ Monday: 9:00 AM - 10:00 PM             ‚îÇ
  ‚îÇ Tuesday: 9:00 AM - 10:00 PM            ‚îÇ
  ‚îÇ ...                                    ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ```

  **Implementation:**
  1. Use `useLocalSearchParams` to get `id` from route
  2. Fetch details with `getPlaceDetails(id)` on mount
  3. Show loading state while fetching
  4. Photo gallery: FlatList horizontal, pagingEnabled, photos at 800px width
  5. Use expo-linking for phone calls (`Linking.openURL(\`tel:${phone}\`)`) and websites
  6. Address tap opens maps (`Linking.openURL(\`maps://?q=${address}\`)` or Google Maps URL)
  7. Price level: Convert 1-4 to $ symbols
  8. Types: Show first 2 types, formatted (replace _ with space, capitalize)
  9. Hours: Show "Open now" / "Closed" badge + expandable weekday list

  **Style (calm, low-density):**
  - White background
  - Generous padding (20px horizontal, 16px between sections)
  - Rounded corners on photo gallery items (12px)
  - Subtle separators between sections
  - Tappable items have subtle background on press

  **Error handling:**
  - Show error message if fetch fails
  - Handle missing fields gracefully (don't render section if null)
  </action>
  <verify>npx tsc --noEmit passes, screen file exists at mobile/app/place/[id].tsx</verify>
  <done>PlaceDetailsScreen renders full details with photo gallery, contact info, and hours</done>
</task>

<task type="auto">
  <name>Task 3: Add photo reference endpoint to backend</name>
  <files>backend/app/routers/places.py</files>
  <action>
  The current photo endpoint (`/api/places/{place_id}/photo`) looks up photo_reference from the places cache by place_id. For the gallery, we need to fetch photos directly by photo_reference.

  Add a new endpoint to fetch photos by reference:

  ```python
  @router.get("/photo")
  async def get_photo_by_reference(
      photo_reference: str = Query(..., description="Google photo reference"),
      max_width: int = Query(default=800, ge=100, le=1600),
      token: str = Query(default=None, description="JWT token for auth"),
  ):
      """
      Get a photo by its photo_reference.

      Used for gallery photos where we already have the reference from details endpoint.
      """
      # Validate token (same as existing photo endpoint)
      if not token:
          raise AuthenticationError(
              message="Authentication required",
              detail={"hint": "Include ?token=<jwt> query parameter"}
          )

      try:
          jwks_client = get_jwks_client()
          signing_key = jwks_client.get_signing_key_from_jwt(token)
          jwt.decode(
              token,
              signing_key.key,
              algorithms=["ES256", "RS256", "HS256"],
              audience="authenticated",
          )
      except jwt.ExpiredSignatureError:
          raise AuthenticationError(message="Token has expired")
      except jwt.InvalidTokenError as e:
          raise AuthenticationError(message="Invalid token", detail={"error": str(e)})

      service = get_places_service()
      photo_data = service.get_place_photo(photo_reference, max_width=max_width)
      if not photo_data:
          raise NotFoundError(message="Failed to fetch photo")

      return StreamingResponse(
          io.BytesIO(photo_data),
          media_type="image/jpeg"
      )
  ```

  Place this BEFORE the `/{place_id}/photo` route to avoid route conflicts (FastAPI matches in order).
  </action>
  <verify>Backend starts without errors, curl to /api/places/photo?photo_reference=xxx&token=xxx works</verify>
  <done>Photo reference endpoint added, gallery photos can be fetched directly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript check passes: `cd mobile && npx tsc --noEmit`
- [ ] PlaceDetails type exists in api.ts
- [ ] getPlaceDetails function works
- [ ] PlaceDetailsScreen at mobile/app/place/[id].tsx exists
- [ ] Backend photo reference endpoint responds
</verification>

<success_criteria>
- PlaceDetailsScreen displays full restaurant info
- Photo gallery shows multiple photos
- Contact info is tappable (phone, website, address)
- Hours section shows weekday text
- All components render without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-place-details-screen/16-01-SUMMARY.md`
</output>
