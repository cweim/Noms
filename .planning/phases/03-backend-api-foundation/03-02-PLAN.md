---
phase: 03-backend-api-foundation
plan: 02
type: execute
---

<objective>
Add centralized error handling and establish router structure for the FastAPI backend.

Purpose: Provide consistent error responses across all endpoints and organize API structure for future feature development.
Output: Production-ready error handling middleware and modular router organization ready for auth, places, and user endpoints.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-api-foundation/03-01-SUMMARY.md
@backend/app/main.py

**Tech stack available:**
- FastAPI 0.109.0 with exception handlers
- Pydantic for response models
- Supabase client integrated

**Established patterns:**
- Async endpoint handlers
- Environment-based configuration

**Future endpoints needed (from roadmap):**
- Phase 4: Auth endpoints (signup, login, logout)
- Phase 5: Google Places endpoints (search, details)
- Phases 9-11: User data endpoints (saves, lists, journal)

**Error handling requirements:**
- Consistent error format across all endpoints
- Appropriate HTTP status codes
- Meaningful error messages (not stack traces to client)
- Logging for debugging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add centralized error handling middleware</name>
  <files>backend/app/main.py, backend/app/errors.py</files>
  <action>
Create backend/app/errors.py:
- Define custom exception classes: DatabaseError, AuthenticationError, NotFoundError, ValidationError
- Each has __init__(self, message: str, detail: dict = None)
- Add error response model using Pydantic BaseModel: ErrorResponse with fields: error (str), message (str), detail (dict, optional)

Update backend/app/main.py:
- Import exception classes and ErrorResponse from app.errors
- Add exception handler for each custom exception using @app.exception_handler()
- DatabaseError → 503 Service Unavailable
- AuthenticationError → 401 Unauthorized
- NotFoundError → 404 Not Found
- ValidationError → 400 Bad Request
- Add catch-all handler for generic Exception → 500 Internal Server Error (log full error, return generic message to client)
- All handlers return ErrorResponse format with appropriate status code

DO NOT expose internal errors or stack traces to clients (security). Log detailed errors server-side, return user-friendly messages to clients.
  </action>
  <verify>python -m app.main starts without errors, custom error classes importable</verify>
  <done>Error handlers registered for custom exceptions, catch-all handler for unexpected errors, consistent ErrorResponse format, no stack traces exposed</done>
</task>

<task type="auto">
  <name>Task 2: Create router structure for future API endpoints</name>
  <files>backend/app/routers/__init__.py, backend/app/main.py, backend/README.md</files>
  <action>
Create backend/app/routers/ directory structure:
- backend/app/routers/__init__.py (empty, makes it a package)

Update backend/app/main.py:
- Add comment section: "# API Routes - To be implemented in future phases"
- Add placeholder comments for future routers:
  ```python
  # Phase 4: Authentication
  # app.include_router(auth.router, prefix="/api/auth", tags=["auth"])

  # Phase 5: Google Places
  # app.include_router(places.router, prefix="/api/places", tags=["places"])

  # Phase 9-11: User Data
  # app.include_router(users.router, prefix="/api/users", tags=["users"])
  ```

Update backend/README.md:
- Add "API Structure" section documenting the router organization
- Explain routers will be implemented in phases 4, 5, and 9-11
- Document error response format (ErrorResponse model structure)

This establishes the pattern for future endpoints without implementing them yet. When we implement auth in Phase 4, we'll create backend/app/routers/auth.py and uncomment the include_router line.
  </action>
  <verify>ls backend/app/routers/ shows __init__.py, backend/README.md documents structure</verify>
  <done>Router directory created, placeholder comments added, README documents API structure and error format</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Error handlers respond with correct status codes
- [ ] ErrorResponse format is consistent
- [ ] No stack traces exposed to clients
- [ ] Router structure documented in README
- [ ] backend/app/routers/ directory exists
</verification>

<success_criteria>

- All tasks completed
- Error handling middleware catches all exception types
- Consistent error response format across API
- Router structure prepared for future endpoints
- Documentation updated
- Phase 3 complete: Backend API Foundation ready
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-api-foundation/03-02-SUMMARY.md`:

# Phase 3 Plan 2: API Infrastructure Summary

**Added error handling and router structure to FastAPI backend**

## Accomplishments

- Created custom exception classes for different error types
- Implemented centralized error handling with consistent response format
- Established router directory structure for future endpoints
- Documented API organization and error format

## Files Created/Modified

- `backend/app/errors.py` - Custom exceptions and ErrorResponse model
- `backend/app/main.py` - Exception handlers and router placeholders
- `backend/app/routers/__init__.py` - Router package initialization
- `backend/README.md` - API structure documentation

## Decisions Made

- ErrorResponse format: {error, message, detail}
- Custom exceptions map to appropriate HTTP status codes
- Stack traces logged server-side, not exposed to clients
- Router organization by feature: /api/auth, /api/places, /api/users
- Prefix pattern: /api/{resource} for all endpoints

## Issues Encountered

[Document any issues or "None"]

## Next Phase Readiness

Phase 3 complete. Backend API foundation established with:
- ✅ FastAPI server with health checks
- ✅ Supabase client integration
- ✅ Database connection management
- ✅ Centralized error handling
- ✅ Router structure prepared

**Ready for Phase 4: Authentication**

Blockers: None

Concerns: None - foundation is solid for auth and places integration
</output>
