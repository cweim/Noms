---
phase: 03-backend-api-foundation
plan: 01
type: execute
---

<objective>
Integrate Supabase client with FastAPI backend and establish database connection management.

Purpose: Enable FastAPI to query the Supabase database established in Phase 2, providing the foundation for all future API endpoints.
Output: FastAPI app connected to Supabase with session management and connection health verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
@.planning/phases/02-database-schema/02-02-SUMMARY.md
@backend/app/main.py
@backend/requirements.txt
@backend/.env.example

**Tech stack available:**
- FastAPI 0.109.0 with uvicorn
- Supabase client library (supabase==2.3.0)
- Python-dotenv for environment config
- Pydantic for data validation

**Established patterns:**
- Environment variables via .env
- Async endpoint handlers
- CORS configured for Expo ports

**Key context:**
- Supabase project configured with credentials in .env.example
- Database has 5 tables: users, places, lists, saved_places, journal_entries
- RLS enabled on all tables with user isolation policies
- Service role key bypasses RLS (for backend operations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client and database connection module</name>
  <files>backend/app/db.py, backend/app/main.py</files>
  <action>
Create backend/app/db.py:
- Import supabase client and os/dotenv
- Load SUPABASE_URL and SUPABASE_SERVICE_KEY from environment (use SERVICE_KEY not ANON_KEY - backend needs to bypass RLS)
- Create supabase client singleton using create_client(url, service_key)
- Add get_supabase() function that returns the client
- Add comments explaining service_role bypasses RLS for backend operations

Update backend/app/main.py:
- Import get_supabase from app.db at top
- Add startup event handler that initializes Supabase client
- Log successful connection (don't log credentials)

DO NOT use ANON_KEY - backend must use SERVICE_KEY to perform admin operations (creating places, querying across users for recommendations). ANON_KEY is for client-side requests with RLS enforcement.
  </action>
  <verify>python -m app.main starts without errors, logs show Supabase client initialized</verify>
  <done>Supabase client created, startup event initializes connection, SERVICE_KEY used for admin access</done>
</task>

<task type="auto">
  <name>Task 2: Add database connection health check to /health endpoint</name>
  <files>backend/app/main.py</files>
  <action>
Update /health endpoint in backend/app/main.py:
- Import get_supabase from app.db
- Query a simple Supabase operation (e.g., supabase.table("users").select("id").limit(1).execute()) wrapped in try/except
- Return {"status": "ok", "database": "connected"} if query succeeds
- Return {"status": "degraded", "database": "disconnected", "error": str(e)} if query fails (with 503 status)
- Use FastAPI's Response to set status code

This proves the connection works and gives us a monitoring endpoint. If the database is down, health check should fail (observability requirement).
  </action>
  <verify>curl http://localhost:8000/health returns {"status": "ok", "database": "connected"} with 200 status</verify>
  <done>Health endpoint verifies database connectivity, returns appropriate status, useful for monitoring</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] python -m app.main starts without errors
- [ ] Supabase client initialized on startup
- [ ] curl http://localhost:8000/health returns database connection status
- [ ] No credentials logged or exposed
</verification>

<success_criteria>

- All tasks completed
- Supabase client integrated with SERVICE_KEY
- Health endpoint verifies database connectivity
- Startup logs confirm initialization
- No errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-api-foundation/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Supabase Integration Summary

**Integrated Supabase client with FastAPI backend**

## Accomplishments

- Created Supabase client singleton with service role access
- Added startup event to initialize database connection
- Enhanced health endpoint to verify database connectivity
- Documented service role vs anon key usage

## Files Created/Modified

- `backend/app/db.py` - Supabase client and connection management
- `backend/app/main.py` - Startup event and health check enhancement

## Decisions Made

- Used SERVICE_KEY (not ANON_KEY) for backend - bypasses RLS for admin operations
- Singleton pattern for Supabase client (shared across requests)
- Health endpoint includes database connectivity check (observability)

## Issues Encountered

[Document any issues or "None"]

## Next Step

Ready for 03-02-PLAN.md (API Infrastructure)
</output>
