# Phase 12: Integration & Polish (Plan 03) - Final Polish

**Goal**: UI consistency fixes, error handling improvements, and sign out functionality

**Depends on**: Plan 12-02 (End-to-End Verification)

## Context

After verifying all flows work, this plan adds final polish:
- Add sign out button to allow switching accounts
- Ensure consistent error handling across screens
- Add pull-to-refresh for lists

## Tasks

### Task 1: Add Sign Out to Tab Bar Header

**File**: `mobile/app/(tabs)/_layout.tsx` (update)

Add a settings/sign out button to the tab layout header:

```typescript
import { Tabs } from 'expo-router';
import { TouchableOpacity, Text, Alert, StyleSheet, View } from 'react-native';
import { useAuth } from '../../lib/auth-context';

function SignOutButton() {
  const { signOut } = useAuth();

  const handleSignOut = () => {
    Alert.alert(
      'Sign Out',
      'Are you sure you want to sign out?',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Sign Out',
          style: 'destructive',
          onPress: signOut,
        },
      ]
    );
  };

  return (
    <TouchableOpacity onPress={handleSignOut} style={styles.signOutButton}>
      <Text style={styles.signOutText}>Sign Out</Text>
    </TouchableOpacity>
  );
}

export default function TabLayout() {
  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: '#1F2937',
        tabBarInactiveTintColor: '#9CA3AF',
        headerShown: false,
      }}
    >
      <Tabs.Screen
        name="now"
        options={{
          title: 'Now',
          tabBarIcon: ({ color }) => <TabIcon name="compass" color={color} />,
        }}
      />
      <Tabs.Screen
        name="saved"
        options={{
          title: 'Saved',
          tabBarIcon: ({ color }) => <TabIcon name="heart" color={color} />,
        }}
      />
      <Tabs.Screen
        name="journal"
        options={{
          title: 'Journal',
          tabBarIcon: ({ color }) => <TabIcon name="camera" color={color} />,
        }}
      />
    </Tabs>
  );
}

function TabIcon({ name, color }: { name: string; color: string }) {
  // Simple text icons for MVP - can replace with vector icons later
  const icons: Record<string, string> = {
    compass: 'üß≠',
    heart: '‚ù§Ô∏è',
    camera: 'üì∑',
  };
  return <Text style={{ fontSize: 20 }}>{icons[name] || '‚óè'}</Text>;
}

const styles = StyleSheet.create({
  signOutButton: {
    marginRight: 16,
    padding: 8,
  },
  signOutText: {
    color: '#EF4444',
    fontSize: 14,
    fontWeight: '600',
  },
});
```

### Task 2: Add Pull-to-Refresh to Saved Screen

**File**: `mobile/app/(tabs)/saved.tsx` (update)

Add RefreshControl to the FlatList for pull-to-refresh:

Find the FlatList component and add refreshControl prop:

```typescript
// Import RefreshControl
import { RefreshControl } from 'react-native';

// In useSavedPlaces hook or component, add refreshing state
const [refreshing, setRefreshing] = useState(false);

const onRefresh = async () => {
  setRefreshing(true);
  await refetch();
  setRefreshing(false);
};

// Add to FlatList
<FlatList
  data={savedPlaces}
  keyExtractor={(item) => item.id}
  renderItem={({ item }) => (
    <SavedPlaceCard place={item} onRemove={() => remove(item.id)} />
  )}
  contentContainerStyle={styles.list}
  refreshControl={
    <RefreshControl
      refreshing={refreshing}
      onRefresh={onRefresh}
      tintColor="#1F2937"
    />
  }
/>
```

### Task 3: Add Pull-to-Refresh to Journal Screen

**File**: `mobile/app/(tabs)/journal.tsx` (update)

Add RefreshControl to the Journal FlatList:

```typescript
// Import RefreshControl
import { RefreshControl } from 'react-native';

// Add refreshing state
const [refreshing, setRefreshing] = useState(false);

const onRefresh = async () => {
  setRefreshing(true);
  await refetch();
  setRefreshing(false);
};

// Add to FlatList
<FlatList
  data={entries}
  keyExtractor={(item) => item.id}
  renderItem={({ item }) => (
    <JournalEntryCard entry={item} onDelete={remove} />
  )}
  contentContainerStyle={styles.list}
  refreshControl={
    <RefreshControl
      refreshing={refreshing}
      onRefresh={onRefresh}
      tintColor="#1F2937"
    />
  }
/>
```

## Verification

After completing tasks:
1. Run TypeScript check: `cd /Users/chinweiming/Desktop/Noms-app/mobile && npx tsc --noEmit`
2. Test sign out from any tab
3. Pull down on Saved list - should refresh
4. Pull down on Journal list - should refresh

## Success Criteria

- Sign out button works and returns to auth screen
- Pull-to-refresh works on Saved screen
- Pull-to-refresh works on Journal screen
- No TypeScript errors

## Notes

- Using emoji icons for simplicity (can upgrade to @expo/vector-icons later)
- Sign out uses confirmation dialog to prevent accidental logout
- Milestone complete after this plan!
