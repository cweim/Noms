# Phase 10: Saved Places (Plan 02) - Mobile Saved Places UI

**Objective:** Integrate save functionality into the picker and display saved places in the Saved tab

**Depends on:** Phase 10-01 (Backend Saves API), Phase 9 (Restaurant Picker)

## Context

The RestaurantPicker component already has an `onLike` callback that fires when user swipes right. Currently it just logs to console. This plan connects it to the backend saves API and builds out the Saved tab to display saved places.

## Tasks

### Task 1: Add Save Functions to API Client

Update `mobile/lib/api.ts` to add saves-related functions:

```typescript
// Types for saves
export interface SavedPlace {
  id: string;
  place_id: string;
  google_place_id: string;
  name: string;
  address: string | null;
  photo_reference: string | null;
  saved_at: string;
  list_id: string | null;
}

export interface SavedPlacesResponse {
  places: SavedPlace[];
  count: number;
}

// Save a place
export async function savePlace(googlePlaceId: string): Promise<SavedPlace> {
  const headers = await getAuthHeaders();
  const response = await fetch(`${API_BASE_URL}/api/saves/`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ google_place_id: googlePlaceId }),
  });

  if (!response.ok) {
    if (response.status === 409) {
      throw new Error('Already saved');
    }
    throw new Error('Failed to save place');
  }

  return response.json();
}

// Get saved places
export async function getSavedPlaces(): Promise<SavedPlacesResponse> {
  const headers = await getAuthHeaders();
  const response = await fetch(`${API_BASE_URL}/api/saves/`, {
    method: 'GET',
    headers,
  });

  if (!response.ok) {
    throw new Error('Failed to fetch saved places');
  }

  return response.json();
}

// Unsave a place
export async function unsavePlace(saveId: string): Promise<void> {
  const headers = await getAuthHeaders();
  const response = await fetch(`${API_BASE_URL}/api/saves/${saveId}`, {
    method: 'DELETE',
    headers,
  });

  if (!response.ok && response.status !== 204) {
    throw new Error('Failed to unsave place');
  }
}
```

**Commit after completion:** `feat(10-02): add saves API functions to mobile client`

### Task 2: Create useSavedPlaces Hook

Create `mobile/lib/use-saved-places.ts`:

```typescript
import { useState, useEffect, useCallback } from 'react';
import { getSavedPlaces, savePlace, unsavePlace, SavedPlace } from './api';

interface UseSavedPlacesResult {
  savedPlaces: SavedPlace[];
  loading: boolean;
  error: string | null;
  save: (googlePlaceId: string) => Promise<boolean>;
  unsave: (saveId: string) => Promise<boolean>;
  refetch: () => void;
}

export function useSavedPlaces(): UseSavedPlacesResult {
  const [savedPlaces, setSavedPlaces] = useState<SavedPlace[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchSavedPlaces = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const response = await getSavedPlaces();
      setSavedPlaces(response.places);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load saved places');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchSavedPlaces();
  }, [fetchSavedPlaces]);

  const save = useCallback(async (googlePlaceId: string): Promise<boolean> => {
    try {
      const saved = await savePlace(googlePlaceId);
      setSavedPlaces((prev) => [saved, ...prev]);
      return true;
    } catch (err) {
      // Silently handle "already saved" error
      if (err instanceof Error && err.message === 'Already saved') {
        return true;
      }
      console.error('Failed to save place:', err);
      return false;
    }
  }, []);

  const unsave = useCallback(async (saveId: string): Promise<boolean> => {
    try {
      await unsavePlace(saveId);
      setSavedPlaces((prev) => prev.filter((p) => p.id !== saveId));
      return true;
    } catch (err) {
      console.error('Failed to unsave place:', err);
      return false;
    }
  }, []);

  return {
    savedPlaces,
    loading,
    error,
    save,
    unsave,
    refetch: fetchSavedPlaces,
  };
}
```

**Commit after completion:** `feat(10-02): add useSavedPlaces hook`

### Task 3: Update Saved Screen and Integrate with Picker

Update `mobile/app/(tabs)/saved.tsx` to display saved places:

```typescript
import { View, Text, StyleSheet, FlatList, ActivityIndicator, TouchableOpacity, Image } from 'react-native';
import { useSavedPlaces, SavedPlace } from '../../lib/use-saved-places';
import { API_BASE_URL } from '../../lib/api';

function SavedPlaceCard({ place, onUnsave }: { place: SavedPlace; onUnsave: (id: string) => void }) {
  const photoUrl = place.photo_reference
    ? `${API_BASE_URL}/api/places/${place.google_place_id}/photo?max_width=400`
    : null;

  return (
    <View style={styles.card}>
      {photoUrl && (
        <Image source={{ uri: photoUrl }} style={styles.cardImage} />
      )}
      <View style={styles.cardContent}>
        <Text style={styles.cardName} numberOfLines={1}>{place.name}</Text>
        {place.address && (
          <Text style={styles.cardAddress} numberOfLines={1}>{place.address}</Text>
        )}
      </View>
      <TouchableOpacity style={styles.unsaveButton} onPress={() => onUnsave(place.id)}>
        <Text style={styles.unsaveText}>Remove</Text>
      </TouchableOpacity>
    </View>
  );
}

export default function SavedScreen() {
  const { savedPlaces, loading, error, unsave, refetch } = useSavedPlaces();

  if (loading) {
    return (
      <View style={styles.centered}>
        <ActivityIndicator size="large" color="#1F2937" />
        <Text style={styles.loadingText}>Loading saved places...</Text>
      </View>
    );
  }

  if (error) {
    return (
      <View style={styles.centered}>
        <Text style={styles.errorText}>{error}</Text>
        <TouchableOpacity style={styles.retryButton} onPress={refetch}>
          <Text style={styles.retryText}>Try Again</Text>
        </TouchableOpacity>
      </View>
    );
  }

  if (savedPlaces.length === 0) {
    return (
      <View style={styles.centered}>
        <Text style={styles.emptyTitle}>No saved places yet</Text>
        <Text style={styles.emptySubtitle}>Swipe right on restaurants you like to save them here</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <Text style={styles.header}>Your Places</Text>
      <FlatList
        data={savedPlaces}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <SavedPlaceCard place={item} onUnsave={unsave} />
        )}
        contentContainerStyle={styles.list}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
  },
  header: {
    fontSize: 28,
    fontWeight: '900',
    color: '#1F2937',
    paddingHorizontal: 20,
    paddingTop: 60,
    paddingBottom: 16,
  },
  list: {
    paddingHorizontal: 20,
    paddingBottom: 100,
  },
  card: {
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    marginBottom: 12,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  cardImage: {
    width: '100%',
    height: 120,
  },
  cardContent: {
    padding: 12,
  },
  cardName: {
    fontSize: 16,
    fontWeight: '700',
    color: '#1F2937',
    marginBottom: 4,
  },
  cardAddress: {
    fontSize: 14,
    color: '#6B7280',
  },
  unsaveButton: {
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
    paddingVertical: 10,
    alignItems: 'center',
  },
  unsaveText: {
    fontSize: 14,
    color: '#EF4444',
    fontWeight: '600',
  },
  centered: {
    flex: 1,
    backgroundColor: '#F5F5F5',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  loadingText: {
    fontSize: 16,
    color: '#6B7280',
    marginTop: 12,
  },
  errorText: {
    fontSize: 16,
    color: '#EF4444',
    textAlign: 'center',
    marginBottom: 16,
  },
  retryButton: {
    backgroundColor: '#1F2937',
    paddingHorizontal: 24,
    paddingVertical: 12,
    borderRadius: 8,
  },
  retryText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
  emptyTitle: {
    fontSize: 20,
    fontWeight: '700',
    color: '#1F2937',
    marginBottom: 8,
  },
  emptySubtitle: {
    fontSize: 16,
    color: '#6B7280',
    textAlign: 'center',
  },
});
```

Update `mobile/app/(tabs)/now.tsx` to use the save function:

```typescript
// Add import
import { useSavedPlaces } from '../../lib/use-saved-places';

// In NowScreen component, add the hook
const { save } = useSavedPlaces();

// Update handleLike
const handleLike = async (place: Place) => {
  const success = await save(place.google_place_id);
  if (success) {
    console.log('Saved:', place.name);
  }
};
```

**Commit after completion:** `feat(10-02): implement saved places screen and integrate with picker`

## Verification

After completing all tasks:
1. Swipe right on restaurant card should save place to backend
2. Saved tab should display all saved places with photos
3. "Remove" button should unsave places
4. Empty state shown when no saved places

## Files Modified

- `mobile/lib/api.ts`
- `mobile/lib/use-saved-places.ts` (new)
- `mobile/app/(tabs)/saved.tsx`
- `mobile/app/(tabs)/now.tsx`
