---
phase: 13-bug-fix-backend-prep
plan: 01
type: execute
---

<objective>
Fix saved places images not displaying bug

Purpose: Saved places in the Saved tab don't show images. The photo_reference may not be properly cached or returned when places are saved.
Output: Working images on saved places cards
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-integration-polish/12-02-SUMMARY.md
@.planning/phases/10-saved-places/10-01-SUMMARY.md

**Key files:**
@backend/app/services/places.py
@backend/app/routers/saves.py
@mobile/app/(tabs)/saved.tsx
@mobile/lib/use-saved-places.ts

**Bug context from 12-02 verification:**
- Saved places images not displaying
- photo_reference may not be properly cached when places are saved
- Images work in picker flow but not in saved places list

**Current flow:**
1. User swipes right on picker card → calls POST /api/saves/ with google_place_id
2. Backend looks up place in places table → returns saved entry with photo_reference
3. Mobile renders image via `/api/places/{google_place_id}/photo?max_width=400`

**Suspected issue:**
- The places table may not have photo_reference populated for all cached places
- OR the photo_reference isn't being returned correctly in the saved places response
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix photo_reference issue</name>
  <files>backend/app/services/places.py, backend/app/routers/saves.py</files>
  <action>
  1. Check if photo_reference is being stored during place caching:
     - In `_cache_place()`, photo_reference comes from `photos[0].get("photo_reference")`
     - Verify this is being upserted correctly

  2. Add logging to trace the issue:
     - Log when photo_reference is extracted and stored
     - Log when photo_reference is returned in saves endpoint

  3. Check if the issue is in the save flow:
     - When POST /api/saves/ is called, it fetches from places table
     - Verify photo_reference field is included in the SELECT query
     - Line 32 in saves.py: `select("id, google_place_id, name, address, photo_reference")`

  4. If photo_reference is NULL in places table:
     - The place may have been cached before photos were available
     - OR the cache upsert may not be updating existing records
     - Check if upsert is preserving NULL when it should update

  Likely fix: The upsert in `_cache_place()` should ONLY update fields that have values,
  or we need to re-fetch place details when saving if photo_reference is missing.

  Alternative approach: When GET /api/saves/ returns places with NULL photo_reference,
  refresh the cache from Google Places API for those specific places.
  </action>
  <verify>Add test logging and check backend logs during a save operation</verify>
  <done>Root cause identified and fixed, photo_reference flows correctly through save pipeline</done>
</task>

<task type="auto">
  <name>Task 2: Verify fix end-to-end</name>
  <files>backend/app/routers/saves.py</files>
  <action>
  1. Ensure the fix is complete:
     - TypeScript check passes: `cd mobile && npx tsc --noEmit`
     - Python files have no syntax errors

  2. Document the fix in code comments if needed

  3. Clean up any debug logging that was only for investigation
  </action>
  <verify>cd /Users/chinweiming/Desktop/Noms-app/mobile && npx tsc --noEmit</verify>
  <done>TypeScript passes, backend code is clean, fix is documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Root cause of missing images identified
- [ ] Fix implemented
- [ ] TypeScript check passes
- [ ] No regressions introduced
</verification>

<success_criteria>
- photo_reference flows correctly from Google Places API → places cache → saved_places response
- Mobile can render images for saved places
- No TypeScript or Python errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-bug-fix-backend-prep/13-01-SUMMARY.md`
</output>
