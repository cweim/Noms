---
phase: 07-map-view
plan: 01
type: execute
---

<objective>
Set up location services and display an interactive map on the Now screen.

Purpose: Establish the map-first experience that is core to the Noms product. Users need to see where they are and what's around them.
Output: Now screen shows a map centered on the user's current location with location permission handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/06-mobile-app-foundation/06-01-SUMMARY.md

# Current mobile setup
@mobile/package.json
@mobile/app.json
@mobile/app/(tabs)/now.tsx
@mobile/app/(tabs)/_layout.tsx

**Tech stack available:**
- Expo ~54.0.31 with React 19.1.0
- expo-router ~6.0.21
- TypeScript ~5.9.2
- Supabase client configured

**Established patterns:**
- UI_SPEC colors: background #F5F5F5, splash #FFF8E7, text #1F2937
- Tab layout with Ionicons
- fontWeight 900, letterSpacing -0.5 for titles
- lib/ directory for shared utilities (supabase.ts, auth-context.tsx)

**Constraining decisions:**
- Phase 6: expo-router v4 for file-based routing
- Phase 6: --legacy-peer-deps for npm (peer dependency conflicts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install map and location packages</name>
  <files>mobile/package.json, mobile/app.json</files>
  <action>
    1. Install packages using expo install (NOT npm install):
       ```
       cd mobile && npx expo install react-native-maps expo-location
       ```

    2. Update mobile/app.json to add location permission config plugin:
       ```json
       {
         "expo": {
           "plugins": [
             "expo-router",
             [
               "expo-location",
               {
                 "locationAlwaysAndWhenInUsePermission": "Allow Noms to use your location to find nearby restaurants."
               }
             ]
           ]
         }
       }
       ```

    3. Add iOS and Android location permission descriptions in app.json:
       - iOS infoPlist: NSLocationWhenInUseUsageDescription
       - Android permissions: ACCESS_FINE_LOCATION, ACCESS_COARSE_LOCATION

    Use npx expo install to get Expo SDK 54 compatible versions. Do NOT use npm install directly for these packages.
  </action>
  <verify>
    1. cd mobile && npm ls react-native-maps expo-location (packages installed)
    2. app.json contains expo-location plugin configuration
  </verify>
  <done>
    - react-native-maps and expo-location installed
    - Location permission strings configured in app.json
    - Plugin configuration added
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLocation hook for location services</name>
  <files>mobile/lib/use-location.ts</files>
  <action>
    Create a custom hook that:

    1. Manages location permission state (not determined, granted, denied)
    2. Requests foreground location permission on mount
    3. Gets current position with high accuracy
    4. Provides loading and error states
    5. Returns { location, loading, error, requestPermission }

    ```tsx
    import { useState, useEffect } from 'react';
    import * as Location from 'expo-location';

    interface LocationState {
      latitude: number;
      longitude: number;
      latitudeDelta: number;
      longitudeDelta: number;
    }

    interface UseLocationResult {
      location: LocationState | null;
      loading: boolean;
      error: string | null;
      permissionStatus: Location.PermissionStatus | null;
      requestPermission: () => Promise<void>;
    }

    export function useLocation(): UseLocationResult {
      // Default to a reasonable delta for city-level view
      const DEFAULT_DELTA = { latitudeDelta: 0.01, longitudeDelta: 0.01 };

      // Implementation:
      // 1. useEffect to request permission on mount
      // 2. If granted, call Location.getCurrentPositionAsync({ accuracy: Location.Accuracy.High })
      // 3. Handle denied state gracefully (show error message)
      // 4. Return region-compatible object for MapView
    }
    ```

    Handle all error cases:
    - Permission denied: Set error message, don't crash
    - Location unavailable: Set error message with fallback
    - Timeout: Use Location.Accuracy.Balanced as fallback

    Do NOT request background location - only foreground is needed for this MVP.
  </action>
  <verify>
    1. File exists: mobile/lib/use-location.ts
    2. TypeScript compiles: cd mobile && npm run tsc
    3. Hook exports useLocation function
  </verify>
  <done>
    - useLocation hook created with permission handling
    - Returns location in MapView-compatible region format
    - Graceful error handling for denied permissions
    - TypeScript types defined
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace Now screen placeholder with MapView</name>
  <files>mobile/app/(tabs)/now.tsx</files>
  <action>
    Replace the placeholder content in now.tsx with:

    1. Import MapView from react-native-maps
    2. Import and use the useLocation hook
    3. Show loading state while getting location
    4. Show error state if permission denied (with button to retry)
    5. Render MapView centered on user's location

    ```tsx
    import { View, Text, StyleSheet, ActivityIndicator, TouchableOpacity } from 'react-native';
    import MapView from 'react-native-maps';
    import { useLocation } from '../../lib/use-location';

    export default function NowScreen() {
      const { location, loading, error, requestPermission } = useLocation();

      if (loading) {
        return (
          <View style={styles.centered}>
            <ActivityIndicator size="large" color="#1F2937" />
            <Text style={styles.loadingText}>Finding your location...</Text>
          </View>
        );
      }

      if (error || !location) {
        return (
          <View style={styles.centered}>
            <Text style={styles.errorText}>{error || 'Unable to get location'}</Text>
            <TouchableOpacity style={styles.retryButton} onPress={requestPermission}>
              <Text style={styles.retryText}>Enable Location</Text>
            </TouchableOpacity>
          </View>
        );
      }

      return (
        <View style={styles.container}>
          <MapView
            style={styles.map}
            initialRegion={location}
            showsUserLocation
            showsMyLocationButton
          />
        </View>
      );
    }
    ```

    Styling:
    - Map fills entire screen (flex: 1)
    - Loading/error states use UI_SPEC colors
    - Error state has retry button with #1F2937 background, white text

    Use showsUserLocation prop to display the blue dot for user position.
    Use showsMyLocationButton for the recenter button (iOS only, but harmless on Android).
  </action>
  <verify>
    1. cd mobile && npm run tsc (no TypeScript errors)
    2. Now screen imports MapView and useLocation
    3. Loading, error, and map states all handled
  </verify>
  <done>
    - Now screen displays MapView instead of placeholder
    - Map centered on user's current location
    - Loading state while fetching location
    - Error state with retry button if permission denied
    - Blue dot shows user location on map
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] react-native-maps and expo-location installed
- [ ] app.json has location permission configuration
- [ ] useLocation hook handles permissions and returns location
- [ ] Now screen shows map centered on user location
- [ ] Loading and error states display correctly
- [ ] No TypeScript errors: cd mobile && npm run tsc
</verification>

<success_criteria>

- All tasks completed
- Map displays on Now tab
- Location permission flow works
- User's position shown with blue dot
- Error handling for denied permissions
</success_criteria>

<output>
After completion, create `.planning/phases/07-map-view/07-01-SUMMARY.md`

Continue to 07-02-PLAN.md for restaurant markers.
</output>
