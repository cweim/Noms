# Phase 11: Photo Journal (Plan 02) - Mobile Photo Capture and Upload

**Goal**: Implement photo selection with expo-image-picker and upload to Supabase Storage

**Depends on**: Phase 6 (Mobile App Foundation), Plan 11-01 (Backend Journal API)

## Context

This plan adds:
- expo-image-picker for selecting photos from library or taking new ones
- Supabase Storage integration for photo uploads
- A reusable photo capture hook

The mobile app already has Supabase client configured in `mobile/lib/supabase.ts`.

## Tasks

### Task 1: Install expo-image-picker

Run in mobile directory:
```bash
cd /Users/chinweiming/Desktop/Noms-app/mobile && npx expo install expo-image-picker
```

Verify installation in package.json.

### Task 2: Create Photo Upload Service

**File**: `mobile/lib/photo-upload.ts` (create)

Create a service for handling photo selection and upload to Supabase Storage:

```typescript
import * as ImagePicker from 'expo-image-picker';
import { supabase } from './supabase';
import 'react-native-url-polyfill/auto';

export interface PhotoUploadResult {
  success: boolean;
  url?: string;
  error?: string;
}

/**
 * Request camera permissions
 */
export async function requestCameraPermission(): Promise<boolean> {
  const { status } = await ImagePicker.requestCameraPermissionsAsync();
  return status === 'granted';
}

/**
 * Request media library permissions
 */
export async function requestMediaLibraryPermission(): Promise<boolean> {
  const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
  return status === 'granted';
}

/**
 * Pick an image from the device's media library
 */
export async function pickImage(): Promise<ImagePicker.ImagePickerResult> {
  // Request permission first to avoid post-selection dialog
  await requestMediaLibraryPermission();

  return ImagePicker.launchImageLibraryAsync({
    mediaTypes: ['images'],
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
  });
}

/**
 * Take a photo with the camera
 */
export async function takePhoto(): Promise<ImagePicker.ImagePickerResult> {
  const hasPermission = await requestCameraPermission();
  if (!hasPermission) {
    return { canceled: true, assets: null };
  }

  return ImagePicker.launchCameraAsync({
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
  });
}

/**
 * Upload an image to Supabase Storage
 * @param uri Local file URI from image picker
 * @param userId User ID for organizing uploads
 */
export async function uploadPhoto(uri: string, userId: string): Promise<PhotoUploadResult> {
  try {
    // Generate unique filename
    const timestamp = Date.now();
    const extension = uri.split('.').pop()?.toLowerCase() || 'jpg';
    const filename = `${userId}/${timestamp}.${extension}`;

    // Fetch the image as a blob
    const response = await fetch(uri);
    const blob = await response.blob();

    // Convert blob to ArrayBuffer for Supabase
    const arrayBuffer = await new Response(blob).arrayBuffer();

    // Upload to Supabase Storage
    const { data, error } = await supabase.storage
      .from('journal-photos')
      .upload(filename, arrayBuffer, {
        contentType: `image/${extension}`,
        upsert: false,
      });

    if (error) {
      console.error('Upload error:', error);
      return { success: false, error: error.message };
    }

    // Get public URL
    const { data: urlData } = supabase.storage
      .from('journal-photos')
      .getPublicUrl(data.path);

    return { success: true, url: urlData.publicUrl };
  } catch (error) {
    console.error('Photo upload failed:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Upload failed'
    };
  }
}

/**
 * Delete a photo from Supabase Storage
 * @param url Public URL of the photo
 */
export async function deletePhoto(url: string): Promise<boolean> {
  try {
    // Extract path from URL
    const urlParts = url.split('/journal-photos/');
    if (urlParts.length < 2) return false;

    const path = urlParts[1];
    const { error } = await supabase.storage
      .from('journal-photos')
      .remove([path]);

    return !error;
  } catch {
    return false;
  }
}
```

### Task 3: Create usePhotoCapture Hook

**File**: `mobile/lib/use-photo-capture.ts` (create)

Create a hook that wraps photo capture and upload logic:

```typescript
import { useState, useCallback } from 'react';
import { Alert } from 'react-native';
import {
  pickImage,
  takePhoto,
  uploadPhoto,
  PhotoUploadResult,
} from './photo-upload';
import { supabase } from './supabase';

export interface UsePhotoCaptureResult {
  photoUri: string | null;
  photoUrl: string | null;
  uploading: boolean;
  error: string | null;
  selectFromLibrary: () => Promise<void>;
  captureWithCamera: () => Promise<void>;
  uploadSelectedPhoto: () => Promise<PhotoUploadResult>;
  clearPhoto: () => void;
}

export function usePhotoCapture(): UsePhotoCaptureResult {
  const [photoUri, setPhotoUri] = useState<string | null>(null);
  const [photoUrl, setPhotoUrl] = useState<string | null>(null);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const selectFromLibrary = useCallback(async () => {
    setError(null);
    const result = await pickImage();

    if (!result.canceled && result.assets?.[0]) {
      setPhotoUri(result.assets[0].uri);
      setPhotoUrl(null); // Clear any previous upload
    }
  }, []);

  const captureWithCamera = useCallback(async () => {
    setError(null);
    const result = await takePhoto();

    if (!result.canceled && result.assets?.[0]) {
      setPhotoUri(result.assets[0].uri);
      setPhotoUrl(null);
    }
  }, []);

  const uploadSelectedPhoto = useCallback(async (): Promise<PhotoUploadResult> => {
    if (!photoUri) {
      return { success: false, error: 'No photo selected' };
    }

    setUploading(true);
    setError(null);

    try {
      // Get current user
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        const err = 'Must be logged in to upload';
        setError(err);
        return { success: false, error: err };
      }

      const result = await uploadPhoto(photoUri, user.id);

      if (result.success && result.url) {
        setPhotoUrl(result.url);
      } else {
        setError(result.error || 'Upload failed');
      }

      return result;
    } finally {
      setUploading(false);
    }
  }, [photoUri]);

  const clearPhoto = useCallback(() => {
    setPhotoUri(null);
    setPhotoUrl(null);
    setError(null);
  }, []);

  return {
    photoUri,
    photoUrl,
    uploading,
    error,
    selectFromLibrary,
    captureWithCamera,
    uploadSelectedPhoto,
    clearPhoto,
  };
}
```

## Verification

After completing tasks:
1. Verify package.json includes expo-image-picker
2. Run TypeScript check: `cd /Users/chinweiming/Desktop/Noms-app/mobile && npx tsc --noEmit`
3. Verify imports work in Expo

## Notes

- Photos are stored in `journal-photos` bucket organized by user ID
- Supabase Storage bucket must be created manually in Supabase dashboard with public access
- Images are compressed to 80% quality and cropped to 1:1 aspect ratio
- ArrayBuffer conversion needed because Supabase doesn't accept blobs directly in React Native
